üöÄ INSTRU√á√ïES COMPLETAS EC2 - ScanDrive
==========================================

üìã INFORMA√á√ïES DA INST√ÇNCIA
---------------------------
‚Ä¢ Dom√≠nio: ec2-3-16-151-20.us-east-2.compute.amazonaws.com
‚Ä¢ IP: 3.16.151.20
‚Ä¢ Usu√°rio: ubuntu
‚Ä¢ Regi√£o: us-east-2

üåê PORTAS DISPON√çVEIS
--------------------
‚Ä¢ 80 (HTTP) - Nginx (redireciona para HTTPS)
‚Ä¢ 443 (HTTPS) - Nginx com SSL
‚Ä¢ 5432 (PostgreSQL) - Banco de dados local (container)
‚Ä¢ 22 (SSH) - Acesso remoto

üö™ MAPEAMENTO DE PORTAS
----------------------
‚Ä¢ Host:80 ‚Üí Nginx:80 (HTTP)
‚Ä¢ Host:443 ‚Üí Nginx:443 (HTTPS)
‚Ä¢ Host:5432 ‚Üí PostgreSQL:5432 (Database)
‚Ä¢ API interna: Porta 80 (n√£o exposta externamente)

üîí PORTAS DE SEGURAN√áA
---------------------
‚Ä¢ SSH (22) - Apenas para administra√ß√£o
‚Ä¢ HTTP (80) - Redireciona para HTTPS
‚Ä¢ HTTPS (443) - Acesso principal da aplica√ß√£o
‚Ä¢ PostgreSQL (5432) - Apenas para desenvolvimento/debug

üîë CONECTAR NA EC2
------------------
ssh -i "pass.pem" ubuntu@ec2-3-16-151-20.us-east-2.compute.amazonaws.com

üìÅ NAVEGA√á√ÉO B√ÅSICA
-------------------
# Ir para o diret√≥rio do projeto
cd ~/ScanDrive-master

# Verificar arquivos
ls -la

# Ver status atual
docker ps

üîÑ ATUALIZA√á√ÉO R√ÅPIDA (COMANDO PRINCIPAL)
-----------------------------------------
# 1. Ir para o diret√≥rio
cd ~/ScanDrive-master

# 2. Atualizar c√≥digo do GitHub
git pull origin main

# 3. Atualizar containers (COMANDO PRINCIPAL)
docker-compose -f docker-compose.https.yml up --build -d --force-recreate

# 4. Verificar status
docker ps

üÜò SOLU√á√ÉO DE PROBLEMAS
-----------------------
# Se der erro de diverg√™ncia no git:
git config pull.rebase false
git pull origin main

# Se precisar parar tudo:
docker-compose -f docker-compose.https.yml down

# Se quiser rebuild completo:
docker-compose -f docker-compose.https.yml build --no-cache

üîç VERIFICA√á√ÉO DO SISTEMA
-------------------------
# Executar script de verifica√ß√£o
bash check-system.sh

# Ver logs em tempo real
docker-compose -f docker-compose.https.yml logs -f

# Ver logs espec√≠ficos da API
docker logs scandrive-master-api-1 --tail 50

# Ver logs do nginx
docker logs scandrive-master-nginx-1 --tail 20

üåê TESTES DE CONECTIVIDADE
--------------------------
# Testar API local
curl -k https://localhost/api/monitoring/health

# Testar swagger
curl -k https://localhost/swagger/v1/swagger.json

# Testar externamente
curl -k https://ec2-3-16-151-20.us-east-2.compute.amazonaws.com/api/monitoring/health

üìñ URLS PARA ACESSO
-------------------
‚Ä¢ API: https://ec2-3-16-151-20.us-east-2.compute.amazonaws.com
‚Ä¢ Swagger: https://ec2-3-16-151-20.us-east-2.compute.amazonaws.com/swagger
‚Ä¢ Health: https://ec2-3-16-151-20.us-east-2.compute.amazonaws.com/api/monitoring/health

‚öôÔ∏è CONFIGURA√á√ÉO ATUAL
---------------------
‚Ä¢ Base de Dados: PostgreSQL (RDS AWS)
‚Ä¢ Proxy: Nginx com SSL
‚Ä¢ API: ASP.NET Core 8.0
‚Ä¢ Certificados: Self-signed SSL

üîê INSTALA√á√ÉO DOS CERTIFICADOS SSL
----------------------------------
# Como criamos os certificados self-signed:

# 1. Criar diret√≥rio para certificados
mkdir -p ssl

# 2. Gerar certificado self-signed
openssl req -x509 -newkey rsa:2048 -keyout ssl/key.pem -out ssl/cert.pem -days 365 -nodes \
  -subj "/C=BR/ST=Estado/L=Cidade/O=ScanDrive/CN=ec2-3-16-151-20.us-east-2.compute.amazonaws.com"

# 3. Verificar se os certificados foram criados
ls -la ssl/

# 4. Configurar permiss√µes
chmod 600 ssl/key.pem
chmod 644 ssl/cert.pem

# NOTA: Let's Encrypt n√£o funciona com dom√≠nios .amazonaws.com
# Por isso usamos certificados self-signed para testes

üîÑ RENOVAR CERTIFICADOS (se necess√°rio)
---------------------------------------
# Remover certificados antigos
rm -f ssl/cert.pem ssl/key.pem

# Gerar novos certificados
openssl req -x509 -newkey rsa:2048 -keyout ssl/key.pem -out ssl/cert.pem -days 365 -nodes \
  -subj "/C=BR/ST=Estado/L=Cidade/O=ScanDrive/CN=ec2-3-16-151-20.us-east-2.compute.amazonaws.com"

# Reiniciar nginx
docker-compose -f docker-compose.https.yml restart nginx

üîß COMANDOS √öTEIS
-----------------
# Status detalhado
docker ps -a

# Espa√ßo em disco
df -h

# Uso de mem√≥ria
free -h

# Limpar containers parados
docker system prune -f

# Ver configura√ß√£o do docker-compose
docker-compose -f docker-compose.https.yml config

# Verificar portas em uso
sudo netstat -tlnp | grep -E ":80|:443|:5432|:22"

# Ver quais portas est√£o ocupadas
sudo lsof -i -P -n | grep LISTEN

üö® RESOLU√á√ÉO DE PROBLEMAS COMUNS
--------------------------------

‚ùå Problema: API unhealthy
‚úÖ Solu√ß√£o: 
cd ~/ScanDrive-master
git pull origin main
docker-compose -f docker-compose.https.yml up --build -d --force-recreate

‚ùå Problema: Swagger n√£o carrega
‚úÖ Solu√ß√£o:
docker logs scandrive-master-api-1 --tail 20
curl -k https://localhost/swagger/v1/swagger.json

‚ùå Problema: 502 Bad Gateway
‚úÖ Solu√ß√£o:
docker logs scandrive-master-nginx-1 --tail 10
docker-compose -f docker-compose.https.yml restart api

‚ùå Problema: Porta ocupada
‚úÖ Solu√ß√£o:
sudo lsof -i :80
sudo lsof -i :443
docker-compose -f docker-compose.https.yml down

üîÑ FLUXO COMPLETO DE ATUALIZA√á√ÉO
--------------------------------
1. cd ~/ScanDrive-master
2. git pull origin main
3. docker-compose -f docker-compose.https.yml down
4. docker-compose -f docker-compose.https.yml up --build -d
5. docker ps
6. curl -k https://localhost/api/monitoring/health

üíæ BACKUP E RECUPERA√á√ÉO
-----------------------
# Backup volumes
docker-compose -f docker-compose.https.yml down
sudo cp -r /var/lib/docker/volumes/scandrive-master_postgres_data /backup/

# Limpar tudo (CUIDADO!)
docker system prune -a -f
docker volume prune -f

üìö ARQUIVOS IMPORTANTES
----------------------
‚Ä¢ docker-compose.https.yml - Configura√ß√£o principal
‚Ä¢ nginx.conf - Configura√ß√£o do proxy
‚Ä¢ ssl/cert.pem e ssl/key.pem - Certificados SSL
‚Ä¢ check-system.sh - Script de verifica√ß√£o
‚Ä¢ DEPLOY-EC2-GUIDE.md - Guia completo

üéØ SEQU√äNCIA PARA CORRE√á√ÉO ATUAL
--------------------------------
1. cd ~/ScanDrive-master
2. git pull origin main
3. docker-compose -f docker-compose.https.yml up --build -d --force-recreate
4. Aguardar 2-3 minutos para containers subirem
5. docker ps (verificar se API est√° healthy)
6. curl -k https://localhost/api/monitoring/health
7. Acessar: https://ec2-3-16-151-20.us-east-2.compute.amazonaws.com/swagger

üèÅ RESULTADO ESPERADO
--------------------
‚Ä¢ 3 containers rodando: nginx, api, db
‚Ä¢ API status: healthy
‚Ä¢ Health check: retorna JSON com status:healthy
‚Ä¢ Swagger: carrega a documenta√ß√£o da API
‚Ä¢ Nginx: proxy reverso funcionando com HTTPS

===============================================
üìû SUPORTE: Se algo n√£o funcionar, execute:
bash check-system.sh
E compartilhe o resultado!
===============================================